generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



model User {
  id              String          @id @default(uuid())
  email           String?         @unique
  phone           String?         @unique
  password        String?
  fullName        String?
  role            Role            @default(CUSTOMER)
  isPhoneVerified Boolean         @default(false)
  isEmailVerified Boolean         @default(false)
  otp             String?
  otps            Otp[]           @relation("Otp")
  otpExpiry       DateTime?
  profile         Profile?
  wallet          Wallet?
  bankAccount     BankAccount?
  oauthAccounts   OAuthAccount[]
  riderLocation   RiderLocation?

  // Ride relations
  passengerRides  Ride[]          @relation("PassengerRides")
  riderRides      Ride[]          @relation("RiderRides")

  // Delivery relations
  sentDeliveries  Delivery[]      @relation("SentDeliveries")
  riderDeliveries Delivery[]      @relation("RiderDeliveries")

  // Addresses
  addresses       Address[]
  
  // Rate requests
  rateRequests    RateRequest[]
  
  // Notifications
  notifications   Notification[]
  
  // Shipments
  shipments       Shipment[]
  
  // Returns
  returns         Return[]
  
  // Support
  supportTickets  SupportTicket[]

  refreshToken    String?

  // Ratings
  givenRatings    Rating[]        @relation("UserRatings")
  receivedRatings Rating[]        @relation("RiderRatings")

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}



model Profile {
  id          String @id @default(uuid())
  user        User   @relation(fields: [userId], references: [id])
  userId      String @unique

  nin         String?
  ninDocument String?
  selfie      String?
  bvn         String?
}




model BankAccount {
  id           String @id @default(uuid())
  user         User   @relation(fields: [userId], references: [id])
  userId       String @unique

  accountNumber String
  accountName   String
  bankName      String
  verified      Boolean @default(false)
}



model OAuthAccount {
  id         String @id @default(uuid())
  provider   String
  providerId String

  user       User   @relation(fields: [userId], references: [id])
  userId     String
}


model Wallet {
  id          String        @id @default(uuid())
  user        User          @relation(fields: [userId], references: [id])
  userId      String        @unique

  balance     Float         @default(0)
  transactions Transaction[]
}

model Transaction {
  id        String   @id @default(uuid())
  wallet    Wallet   @relation(fields: [walletId], references: [id])
  walletId  String
  amount    Float
  type      String
  meta      Json?
  createdAt DateTime @default(now())
}



model RiderLocation {
  id         String   @id @default(uuid())
  rider      User     @relation(fields: [riderId], references: [id])
  riderId    String   @unique

  latitude   Float
  longitude  Float
  isAvailable Boolean @default(true)
  updatedAt  DateTime @updatedAt
}




model Ride {
  id           String     @id @default(uuid())

  passenger    User       @relation("PassengerRides", fields: [passengerId], references: [id])
  passengerId  String

  rider        User?      @relation("RiderRides", fields: [riderId], references: [id])
  riderId      String?

  originLat    Float
  originLng    Float
  destLat      Float
  destLng      Float
  price        Float
  status       RideStatus @default(PENDING)

  rating       Rating?    @relation("RideRatings")

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}




model Delivery {
  id        String   @id @default(uuid())
  originLat Float
  originLng Float
  destLat   Float
  destLng   Float
  status    DeliveryStatus @default(PENDING)
  price     Float
  metadata  Json?          // Add this line
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender    User     @relation("SentDeliveries", fields: [senderId], references: [id])
  senderId  String
  rider     User?    @relation("RiderDeliveries", fields: [riderId], references: [id])
  riderId   String?

  @@map("deliveries")
}



model Rating {
  id        String @id @default(uuid())

  user      User   @relation("UserRatings", fields: [userId], references: [id])
  userId    String

  rider     User   @relation("RiderRatings", fields: [riderId], references: [id])
  riderId   String

  ride      Ride?  @relation("RideRatings", fields: [rideId], references: [id])
  rideId    String? @unique

  score     Int
  comment   String?
  createdAt DateTime @default(now())
}

model Promotion {
  id          String   @id @default(uuid())
  title       String
  code        String   @unique
  discount    Float
  expiryDate  DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Otp {
  id          String @id @default(uuid())
  user        User?   @relation("Otp", fields: [userId], references: [id])
  userId      String? @unique
  phone       String @unique
  otp         String
  expiresAt   DateTime
  password    String?
  fullName    String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Address Model
model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String   // e.g., 'home', 'work', 'other'
  name        String
  phone       String
  address     String
  city        String
  state       String
  country     String
  postalCode  String?
  isDefault   Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  coordinates Json?    // { lat: Float, lng: Float }
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// Rate Request/Response Model
model RateRequest {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  requestToken  String   @unique
  status        String   @default("pending")
  requestData   Json     // Original request payload
  responseData  Json?    // API response data
  selectedRate  Json?    // User selected rate
  metadata      Json?    // Additional metadata
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  rates         Rate[]   @relation("RequestRates")

  @@index([userId])
  @@index([requestToken])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String   // e.g., 'shipment_created', 'shipment_picked_up'
  title       String
  message     String
  isRead      Boolean  @default(false)
  readAt      DateTime?
  data        Json?    // Additional data like { shipmentId: '123' }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, isRead])
}

model Shipment {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  trackingNumber    String   @unique
  shipbubbleId      String?
  senderName        String
  senderPhone       String
  senderEmail       String?
  senderAddress     String
  senderCity        String
  senderState       String
  senderCountry     String
  courierServiceCode String?
  receiverName      String
  receiverPhone     String
  receiverEmail     String?
  receiverAddress   String
  receiverCity      String
  receiverState     String
  receiverCountry   String
  courierId         String?
  requestToken      String?
  weight            Float?
  dimension         String?
  category          String?
  description       String?
  items             Json?     // Array of items
  codAmount         Float?
  insuranceCode     String?
  status            String    // e.g., 'created', 'in_transit', 'delivered'
  currentLocation   String?
  estimatedDelivery DateTime?
  waybillUrl        String?
  amount            Float
  cancellationReason String?
  cancelledAt       DateTime?
  deliveredAt       DateTime?
  lastUpdated       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  returns           Return[]  @relation("ShipmentReturns")

  @@index([userId, status])
  @@index([trackingNumber])
}

model Return {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  originalShipment  Shipment @relation("ShipmentReturns", fields: [originalShipmentId], references: [id])
  originalShipmentId String
  trackingNumber    String   @unique
  shipbubbleId      String?
  reason            String
  status            String   // e.g., 'created', 'processing', 'completed'
  waybillUrl        String?
  amount            Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId, status])
  @@index([trackingNumber])
}

model SupportTicket {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  subject     String
  status      String           // 'open', 'awaiting_response', 'closed'
  priority    String           // 'low', 'medium', 'high'
  messages    SupportMessage[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId, status])
}

model SupportMessage {
  id        String        @id @default(uuid())
  ticket    SupportTicket @relation(fields: [ticketId], references: [id])
  ticketId  String
  sender    String        // 'user' or 'support'
  message   String
  attachments Json?       // Array of attachment objects
  createdAt DateTime      @default(now())

  @@index([ticketId])
}

model WebhookLog {
  id          String   @id @default(uuid())
  eventType   String
  payload     Json
  status      String   // 'received', 'processed', 'error'
  error       String?
  processedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([eventType, status])
  @@index([createdAt])
}

model Courier {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  isActive    Boolean  @default(true)
  logoUrl     String?
  apiConfig   Json?    // API configuration for the courier
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Package {
  id          String   @id @default(uuid())
  name        String
  description String?
  weight      Float
  length      Float
  width       Float
  height      Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Rate {
  id            String     @id @default(uuid())
  requestId     String
  request       RateRequest @relation("RequestRates", fields: [requestId], references: [id])
  carrier       String
  service       String
  rate          Float
  currency      String    @default("NGN")
  deliveryDays  Int?
  estimatedDate DateTime?
  serviceCode   String?
  carrierCode   String?
  meta          Json?     // Additional carrier-specific data
  createdAt     DateTime  @default(now())
}

// Add these enums if not already present in your schema
enum Role {
  CUSTOMER
  RIDER
  ADMIN
}

enum RideStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}


